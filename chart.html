<!DOCTYPE html>
<html>
<head>
  <META HTTP-EQUIV='Content-Security-Policy' CONTENT="default-src https:; script-src https: 'unsafe-inline'; style-src https: 'unsafe-inline'" />
  <meta charset="UTF-8">
      <style>
      canvas {
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
         height:100vh;
  width:100vw;
}

  </style>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
</head>

<body translate="no" >

 <div class="preloader-wrapper small active" id="loader" style="top: 50%; left: 50%; position: absolute;">
    <div class="spinner-layer spinner-green-only">
      <div class="circle-clipper left">
        <div class="circle"></div>
      </div><div class="gap-patch">
        <div class="circle"></div>
      </div><div class="circle-clipper right">
        <div class="circle"></div>
      </div>
    </div>
  </div>
        
  <script src="https://cdn.rawgit.com/chartjs/chartjs.github.io/master/dist/2.6.0/Chart.bundle.js">
</script>
<script src="https://cdn.rawgit.com/chartjs/chartjs.github.io/master/samples/2.6.0/utils.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js'></script>

    <script>
    "use strict";
      

function getJsonFromUrl() {
  var query = location.search.substr(1);
  var result = {};
  query.split("&").forEach(function(part) {
    var item = part.split("=");
    result[item[0]] = decodeURIComponent(item[1]);
  });
  return result;
}
var f = getJsonFromUrl()
    var stock = f['stock'];
var daysback = f['daysback'];
var config = {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      label: stock,
        backgroundColor: "#ffffff",
        borderColor: "#16161d",
      data: [],
      fill: false
    }]
  },
  options: {
    responsive: true,
    title: {
      display: false,
      text: stock
    },
    tooltips: {
      mode: "index",
      intersect: false
    },
    hover: {
      mode: "nearest",
      intersect: true
    },
    scales: {
      xAxes: [{
        display: true,
        scaleLabel: {
          display: false,
          labelString: "Month"
        }
      }],
      yAxes: [{
        display: true,
        scaleLabel: {
          display: false,
          labelString: "Price"
        }
      }]
    }
  }
};


function loadChart() {
  
  var element = document.createElement("canvas")
  element.id= "canvas"
  document.getElementsByTagName("body")[0].appendChild(element)
  var ctx = document.getElementById("canvas").getContext("2d");
  window.myLine = new Chart(ctx, config);
  document.getElementById("loader").style.display= "none";
};

(function(){
  if (typeof Object.defineProperty === 'function'){
    try{Object.defineProperty(Array.prototype,'sortBy',{value:sb}); }catch(e){}
  }
  if (!Array.prototype.sortBy) Array.prototype.sortBy = sb;

  function sb(f){
    for (var i=this.length;i;){
      var o = this[--i];
      this[i] = [].concat(f.call(o,o,i),o);
    }
    this.sort(function(a,b){
      for (var i=0,len=a.length;i<len;++i){
        if (a[i]!=b[i]) return a[i]<b[i]?-1:1;
      }
      return 0;
    });
    for (var i=this.length;i;){
      this[--i]=this[i][this[i].length-1];
    }
    return this;
  }
})();

var xhttp = new XMLHttpRequest();
xhttp.onreadystatechange = function() {
  try {
  if (this.readyState == 4 && this.status == 200) {
        var parsed = JSON.parse(this.responseText)
    loadChart()
    config.data.datasets[0].data = [];
    var labels = [];
    for (let k of parsed["dataset"]["data"].slice(
      0,
      daysback
    )) {
      console.log(k[1]);
      config.data.datasets[0].data.push(k[1]);
      //var date = config.data.labels.push(k[0]);
      //moment("date", "YYYY-MM-DD").fromNow();
      labels.push(k[0]);
      
    }
    config.data.datasets[0].data = config.data.datasets[0].data.sort();
    labels = labels.sort(function(a, b) {
   return new Date(b.date) - new Date(a.date);
    });
    labels.sortBy(function(o){ return o });
    for (let label of labels) {
      config.data.labels.push(moment(label, "YYYY-MM-DD").format('MMMM Do'));
    }
    window.myLine.update();
    document.getElementById("canvas").className += "visiblecanvas"
  }
  }
    catch(err) {
      
      //document.getElementsByTagName("body")[0].innerHTML = "<center>No data found...</center>"
      return; 
    
    }
}


xhttp.open("GET", "https://ssappquandlbackend.glitch.me/?url=+"+encodeURIComponent("https://www.quandl.com/api/v3/datasets/WIKI/"+stock+"?granularity=daily&api_key=yvbwpmxTwWCCzmfsBuAW"), true);
xhttp.send();
      

      function reload(stock) {
  document.getElementById("loader").style.display= "default";
 var ele =  document.getElementById("canvas")
 if (ele != null) {
   ele.remove() 
 }
xhttp.open("GET", "https://ssappquandlbackend.glitch.me/?url=+"+encodeURIComponent("https://www.quandl.com/api/v3/datasets/WIKI/"+stock+"?granularity=daily&api_key=yvbwpmxTwWCCzmfsBuAW"), true);
xhttp.send();
      
      }
      
      function receiveMessage(event){
  reload(event.data)
}
      
            window.addEventListener("message", receiveMessage, false);

  </script>

  
  

</body>
</html>
 
